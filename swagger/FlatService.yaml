openapi: 3.0.3
info:
  title: Сервис реестра квартир
  description: Сервис реестра квартир, REST эндпоинты для первой лабораторной по СОА
  version: 1.0.0
servers:
  - url: 'http://localhost:335159/api/v1/'
paths:
  # CRUD операции
  /flats/:
    post:
      summary: Добавление новой квартиры
      operationId: addFlat
      tags:
        - Registry
      requestBody:
        required: true
        content:
          application/xml:
            schema:
              $ref: '#/components/schemas/FlatAllFieldsSchema'
      responses:
        '200':
          description: Успешно добавлена новая квартира
          content:
            application/xml:
              schema:
                $ref: '#/components/schemas/FlatAllFieldsSchema'
        '405':
          description: Ошибка валидации
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: Error
                properties:
                  messages:
                    type: array
                    items:
                      type: string
                      example: Значение поля area меньше или равно 0
                      xml:
                        name: message
                    xml:
                      name: messages
                      wrapped: true
                  time:
                    type: string
                    format: date-time
                    example: 2024-11-10T00:10:12Z
        '500':
          description: Внутренняя ошибка сервера
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: Error
                properties:
                  message:
                    type: string
                    example: Внутренняя ошибка сервера
                  time:
                    type: string
                    format: date-time
                    example: 2024-11-10T00:10:12Z
        default:
          description: Возвращает сообщение об ошибке и время возникновения ошибки
          content:
            application/xml:
              schema:
                $ref: '#/components/schemas/Error'
    get:
      summary: Получить список квартир
      description: Получить список квартир с сортировкой и пагинацией
      operationId: getFlats
      parameters:
        - name: sort
          in: query
          description: >
            Массив полей, используемых для сортировки.<br>
            Знак «минус» означает сортировку по убыванию.<br>
            Без знака «минус» означает сортировку по возрастанию.<br>
            Если для одного поля указаны сортировка по возрастанию и по убыванию (с минусом и без него), будет возвращена ошибка (код 400).
          required: false
          explode: true
          schema:
            type: array
            items:
              type: string
              default: id
              enum:
                - id
                - name
                - coordinates.x
                - coordinates.y
                - creationDate
                - area
                - numberOfRooms
                - height
                - view
                - transport
                - house.name
                - house.year
                - house.numberOfFlatsOnFloor
                - -id
                - -name
                - -coordinates.x
                - -coordinates.y
                - -creationDate
                - -area
                - -numberOfRooms
                - -height
                - -view
                - -transport
                - -house.name
                - -house.year
                - -house.numberOfFlatsOnFloor
        - name: filter
          in: query
          required: false
          description: >
            Список фильтров полей.<br>
            Формат каждого элемента, кроме интервала и диапазона: `field[operation]:value`.<br>
            Формат для интервала и диапазона `field[operation]:min,max`<br>
            Доступные операции:<br>
            - `eq` - равно<br>
            - `ne` - не равно<br>
            - `gt` - больше (строго) - можно использовать отдельно или в комбинации с `lt` для задания открытого интервала `(min,max)`<br>
            - `lt` - меньше (строго)<br>
            - `gte` - больше или равно - можно использовать в комбинации с `lte` для задания закрытого диапазона `[min,max]`<br>
            - `lte` - меньше или равно<br>
            - `interval` - интервал **без** включённых границ, значение: `min,max` (соответствует `(min, max)`)<br>
            - `range` - диапазон **с** включёнными границами, значение: `min,max` (соответствует `[min, max]`)<br>
            Примеры:<br>
            - `area[gt]:10` — area > 10<br>
            - `area[interval]:10,20` - 10 < area < 20 (границы не включены)<br>
            - `numberOfRooms[range]:1,3` - 1 ≤ numberOfRooms ≤ 3 (границы включены)<br>
            Если `operation` - `interval` или `range`, то `value` **должен** быть двумя значениями, разделёнными запятой.<br>
            В противном случае - одно значение. Если значение некорректно - возвращается ошибка с кодом 400.
          style: deepObject
          explode: true
          schema:
            type: array
            items:
              type: string
              example: area[interval]:10,20
              # общий синтакс: поле + операция + : + значение (для interval/range — два значения через запятую)
              pattern: '^(?:(?:id|name|coordinates\.x|coordinates\.y|creationDate|area|numberOfRooms|height|view|transport|house\.name|house\.year|house\.numberOfFlatsOnFloor)\[(?:eq|ne|gt|lt|lte|gte)\]:[^,]+|(?:id|name|coordinates\.x|coordinates\.y|creationDate|area|numberOfRooms|height|view|transport|house\.name|house\.year|house\.numberOfFlatsOnFloor)\[(?:interval|range)\]:[^,]+,[^,]+)$'
        - name: page
          in: query
          required: false
          description: Задаёт номер страницы для пагинации. По умолчанию возвращает первую страницу
          schema:
            type: integer
            default: 0
            minimum: 0
        - name: pageSize
          in: query
          required: false
          description: Задаёт размер страницы для пагинации. По умолчанию размер страницы равен 10
          schema:
            type: integer
            default: 10
            minimum: 1
      tags:
        - Registry
      responses:
        '200':
          description: Успешно получен массив квартир на основе переданных параметров
          content:
            application/xml:
              schema:
                $ref: '#/components/schemas/FlatsAllFieldsSchema'
        '400':
          description: Предоставлен(ы) неверный(е) параметр(ы)
          content:
            applicaiton/xml:
              schema:
                type: object
                xml:
                  name: Error
                properties:
                  message:
                    type: string
                    example: Предоставлен неверный параметр
                  time:
                    type: string
                    format: date-time
                    example: 2024-11-10T00:10:12Z
        '500':
          description: Внутренняя ошибка сервера
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: Error
                properties:
                  message:
                    type: string
                    example: Внутренняя ошибка сервера
                  time:
                    type: string
                    format: date-time
                    example: 2024-11-10T00:10:12Z
        default:
          description: Возвращает сообщение об ошибке и время возникновения ошибки
          content:
            application/xml:
              schema:
                $ref: '#/components/schemas/Error'
    # Дополнительная операция
    delete:
      summary: Удалить одну квартиру по фильтру
      description: >
        Удаляет один (любой) объект квартиры, соответствующий указанным фильтрам.<br>
        Если найдено несколько соответствующих записей, удаляется первая подходящая запись.
      operationId: deleteOneFlatByFilter
      parameters:
        - name: houseName
          in: query
          description: Фильтр значений по полю House.name для удаления квартиры
          required: false
          schema:
            type: string
            nullable: false
            minLength: 1
            example: First House
        - name: houseYear
          in: query
          description: Фильтр значений по полю House.year для удаления квартиры
          required: false
          schema:
            type: integer
            nullable: false
            minimum: 0
            exclusiveMinimum: true
            example: 2000
        - name: numberOfFlatsOnFloor
          in: query
          description: Фильтр значений по полю House.numberOfFlatsOnFloor для удаления квартиры
          required: false
          schema:
            type: integer
            nullable: false
            minimum: 0
            exclusiveMinimum: true
            example: 9
      tags:
        - Registry
      responses:
        '204':
          description: Квартира была успешно удалена
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: Error
                properties:
                  message:
                    type: string
                    example: Квартира была успешно удалена
                  time:
                    type: string
                    format: date-time
                    example: 2024-11-10T00:10:12Z
        '404':
          description: Квартира не найдена для удаления не найдена
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: Error
                properties:
                  message:
                    type: string
                    example: Квартира не найдена для удаления не найдена
                  time:
                    type: string
                    format: date-time
                    example: 2024-11-10T00:10:12Z
        '500':
          description: Внутренняя ошибка сервера
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: Error
                properties:
                  message:
                    type: string
                    example: Внутренняя ошибка сервера
                  time:
                    type: string
                    format: date-time
                    example: 2024-11-10T00:10:12Z
        default:
          description: Возвращает сообщение об ошибке и время возникновения ошибки
          content:
            application/xml:
              schema:
                $ref: '#/components/schemas/Error'

  # CRUD операции по id
  /flats/{id}:
    get:
      summary: Получить существующую квартиру по id
      description: Получить существующую квартиру по id
      operationId: getFlat
      parameters:
        - name: id
          in: path
          description: Id для поиска квартиры
          required: true
          schema:
            type: integer
            nullable: false
            minimum: 0
            exclusiveMinimum: true
            example: 1
      tags:
        - Registry
      responses:
        '200':
          description: Успешно получена квартира по id
          content:
            application/xml:
              schema:
                $ref: '#/components/schemas/FlatAllFieldsSchema'
        '400':
          description: Передан неправильный параметр
          content:
            applicaiton/xml:
              schema:
                type: object
                xml:
                  name: Error
                properties:
                  message:
                    type: string
                    example: Передан неправильный параметр
                  time:
                    type: string
                    format: date-time
                    example: 2024-11-10T00:10:12Z
        '404':
          description: Не найдена квартира по переданному id
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: Error
                properties:
                  message:
                    type: string
                    example: Не найдена квартира по переданному id
                  time:
                    type: string
                    format: date-time
                    example: 2024-11-10T00:10:12Z
        '500':
          description: Внутренняя ошибка сервера
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: Error
                properties:
                  message:
                    type: string
                    example: Внутренняя ошибка сервера
                  time:
                    type: string
                    format: date-time
                    example: 2024-11-10T00:10:12Z
        default:
          description: Возвращает сообщение об ошибке и время возникновения ошибки
          content:
            application/xml:
              schema:
                $ref: '#/components/schemas/Error'
    put:
      summary: Обновление существующей квартиры по id
      description: Обновление существующей квартиры по id
      operationId: updateFlat
      parameters:
        - name: id
          in: path
          description: Id квартиры для обновления
          required: true
          schema:
            type: integer
            nullable: false
            minimum: 0
            exclusiveMinimum: true
            example: 1
      tags:
        - Registry
      requestBody:
        required: true
        content:
          application/xml:
            schema:
              $ref: '#/components/schemas/FlatAllFieldsSchema'
      responses:
        '200':
          description: Успешно обновлен объект квартиры и получен обновленный объект квартиры
          content:
            application/xml:
              schema:
                $ref: '#/components/schemas/FlatAllFieldsSchema'
        '405':
          description: Ошибка валидации переданного объекта
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: Error
                properties:
                  messages:
                    type: array
                    items:
                      type: string
                      example: Значение поля area меньше или равно 0
                      xml:
                        name: message
                    xml:
                      name: messages
                      wrapped: true
                  time:
                    type: string
                    format: date-time
                    example: 2024-11-10T00:10:12Z
        '500':
          description: Внутренняя ошибка сервера
          content:
            application/xmll:
              schema:
                type: object
                xml:
                  name: Error
                properties:
                  message:
                    type: string
                    example: Внутренняя ошибка сервера
                  time:
                    type: string
                    format: date-time
                    example: 2024-11-10T00:10:12Z
        default:
          description: Возвращает сообщение об ошибке и время возникновения ошибки
          content:
            application/xml:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      summary: Удаляет существующую квартиру по id
      description: Удаляет существующую квартиру по id
      operationId: deleteFlat
      parameters:
        - name: id
          in: path
          description: Id квартиры для удаления
          required: true
          schema:
            type: integer
            nullable: false
            minimum: 0
            exclusiveMinimum: true
      tags:
        - Registry
      responses:
        '204':
          description: Квартира была успешно удалена
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: Error
                properties:
                  message:
                    type: string
                    example: Квартира была успешно удалена
                  time:
                    type: string
                    format: date-time
                    example: 2024-11-10T00:10:12Z
        '404':
          description: Не найдена квартира по переданному id
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: Error
                properties:
                  message:
                    type: string
                    example: Не найдена квартира по переданному id
                  time:
                    type: string
                    format: date-time
                    example: 2024-11-10T00:10:12Z
        '500':
          description: Внутренняя ошибка сервера
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: Error
                properties:
                  message:
                    type: string
                    example: Внутренняя ошибка сервера
                  time:
                    type: string
                    format: date-time
                    example: 2024-11-10T00:10:12Z
        default:
          description: Возвращает сообщение об ошибке и время возникновения ошибки
          content:
            application/xml:
              schema:
                $ref: '#/components/schemas/Error'

  # Дополнительные операции
  /lab-works/amount/height:
    get:
      summary: Получить сумму полей «height» для всех квартир
      description: Получить сумму полей «height» для всех квартир
      operationId: getAmountOfFieldsHeight
      tags:
        - Registry
      responses:
        '200':
          description: Успешно получена сумма полей «height» для всех квартир
          content:
            application/xml:
              schema:
                type: integer
                xml:
                  name: Response
                format: int64
                nullable: false
                minimum: 0
                example: 123
        '500':
          description: Внутренняя ошибка сервера
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: Error
                properties:
                  message:
                    type: string
                    example: Внутренняя ошибка сервера
                  time:
                    type: string
                    format: date-time
                    example: 2024-11-10T00:10:12Z
        default:
          description: Возвращает сообщение об ошибке и время возникновения ошибки
          content:
            application/xml:
              schema:
                $ref: '#/components/schemas/Error'

  /flats/group-by/height:
    get:
      summary: Группировка квартир по значению поля "height"
      description: Группировка квартир по значению поля "height"
      operationId: groupByHeight
      tags:
        - Registry
      responses:
        '200':
          description: Успешно возвращены сгруппированные квартиры по значению поля "height"
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: groups
                properties:
                  group:
                    type: array
                    items:
                      type: object
                      properties:
                        height:
                          type: integer
                          nullable: false
                          description: Номер этажа квартиры
                          minimum: 0
                          exclusiveMinimum: true
                          example: 10
                        count:
                          type: integer
                          nullable: false
                          description: Количество квартир с таким же значением номера этажа
                          minimum: 0
                          exclusiveMinimum: true
                          example: 8
        '500':
          description: Внутренняя ошибка сервера
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: Error
                properties:
                  message:
                    type: string
                    example: Внутренняя ошибка сервера
                  time:
                    type: string
                    format: date-time
                    example: 2024-11-10T00:10:12Z
        default:
          description: Возвращает сообщение об ошибке и время возникновения ошибки
          content:
            application/xml:
              schema:
                $ref: "#/components/schemas/Error"

# Схемы объектов
components:
  schemas:
    FlatAllFieldsSchema:
      type: object
      xml:
        name: Flat
      properties:
        id:
          type: integer
          nullable: false
          minimum: 0
          exclusiveMinimum: true
          example: 1
          description: Уникальный идентификатор квартиры, генерируется автоматически
          readOnly: true
        name:
          type: string
          nullable: false
          minLength: 1
          example: Первая квартира
        coordinates:
          $ref: '#/components/schemas/Coordinates'
        creationDate:
          type: string
          format: date-time
          nullable: false
          example: 2024-11-10
          description: Дата и время создания объекта, генерируется автоматически
          readOnly: true
        area:
          type: integer
          nullable: true
          minimum: 0
          exclusiveMinimum: true
          example: 1
        numberOfRooms:
          type: integer
          nullable: false
          minimum: 0
          exclusiveMinimum: true
          example: 1
        height:
          type: integer
          nullable: false
          minimum: 0
          exclusiveMinimum: true
          example: 10
          description: Номер этажа квартиры
        view:
          $ref: '#/components/schemas/View'
        transport:
          $ref: '#/components/schemas/Transport'
        house:
          $ref: '#/components/schemas/House'
      required:
        - name
        - coordinates
        - numberOfRooms
        - height
        - house

    FlatsAllFieldsSchema:
      type: object
      xml:
        name: FlatsPage
      properties:
        flats:
          type: array
          nullable: false
          items:
            $ref: '#/components/schemas/FlatAllFieldsSchema'
          xml:
            name: flats
            wrapped: true
        page:
          type: integer
          nullable: false
          minimum: 0
          default: 0
        pageSize:
          type: integer
          nullable: false
          minimum: 0
          default: 20
        totalPages:
          type: integer
          nullable: false
          minimum: 0
          default: 1
        totalAmount:
          type: integer
          nullable: false
          minimum: 0
          default: 0
          example: 1
      required:
        - flats
        - page
        - pageSize
        - totalPages
        - totalAmount

    Coordinates:
      type: object
      nullable: false
      properties:
        x:
          type: number
          format: float
          nullable: false
          minimum: -993
          exclusiveMinimum: true
          example: 1.1
        y:
          type: number
          format: int64
          nullable: false
          example: 123
      required:
        - x
        - y

    House:
      type: object
      nullable: false
      properties:
        name:
          type: string
          nullable: false
          example: Первый дом
        year:
          type: integer
          nullable: true
          minimum: 0
          exclusiveMinimum: true
          example: 2000
        numberOfFlatsOnFloor:
          type: integer
          nullable: true
          minimum: 0
          exclusiveMinimum: true
          example: 9
      required:
        - name

    View:
      type: string
      nullable: true
      example: STREET
      enum:
        - STREET
        - YARD
        - BAD
        - GOOD

    Transport:
      type: string
      nullable: true
      example: FEW
      enum:
        - FEW
        - NONE
        - LITTLE
        - NORMAL
        - ENOUGH

    Error:
      type: object
      properties:
        message:
          type: string
          example: Запрашиваемый ресурс не найден
        time:
          type: string
          format: date-time
          example: 2024-11-10T00:10:12Z
      required:
        - message
        - time
